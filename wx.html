<!DOCTYPE html>
<html lang="en">
<head>
<meta name="google-site-verification" content="P6rqWS7FvCkbQVwIJLtztDsRWp4XSqEZeMLUkLn_MMo" />
<meta charset="UTF-8">
<title>Seamless Map ‚Äì Overlay Tab Left Middle, Info Panel Right Middle</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<style>
html, body { height:100%; width:100%; padding:0; margin:0; }
body { min-height:100dvh; }

/* Dusk/Day world map filters */
body.dusk-mode .world-map {
    filter: brightness(1.08) sepia(0.08) hue-rotate(-13deg) saturate(1.22) contrast(1.09);
    background-color: #7e87c0!important;
}
body.day-mode .world-map {
    filter: brightness(1.13) contrast(1.16) sepia(0.03) hue-rotate(-7deg) saturate(1.25);
    background-color: #daf0ff!important;
}

/* Dusk and day mode related styling only */
body.dusk-mode .weather-panel  { background: #b3b6dbed; color: #263163; }
body.day-mode .weather-panel   { background: #fff; color: #232425; }
body.dusk-mode .overlay-controls { background:#b3b6dbce;}
body.day-mode .overlay-controls { background:#eefdffde; color:#222;}
body.dusk-mode .overlay-controls label,
body.day-mode .overlay-controls label{ color:#23242d;}
body.day-mode .location-marker { background:#ffe; color:#0069cc;}
body.dusk-mode .location-marker { background: #ece8ff; color: #464093;}

/* Layout */
.map-container { position:relative; width:100vw; height:100vh; overflow:hidden; }

.map-viewport {
    width:100vw;
    height:100vh;
    overflow:hidden;
    position:relative;
    touch-action:none;
    cursor: pointer;
}

.map-tiles-wrap {
    width:300vw; height:100vh;
    display:flex; position:absolute; top:0; left:0;
    will-change:transform;
    transition: transform 0.24s cubic-bezier(.68,-0.55,.27,1.55);
}
.map-tiles-wrap.dragging { transition:none; }

.world-map, .overlay-img {
    width:100vw; height:100vh; min-width:100vw; min-height:100vh;
    object-fit:cover; pointer-events:none; user-drag:none; user-select:none;
    position: absolute; left:0; top:0; transition: filter .22s, background-color .2s; z-index: 1;
}
.overlay-img { opacity: 0.7; pointer-events:none; z-index:10; }
.overlay-img.hidden { opacity:0 !important; }

.overlay-controls {
    position: fixed; left: 0; top: 50%; transform: translateY(-50%);
    z-index: 301; display: flex; flex-direction: column; gap: 6px;
    border-radius: 13px; padding: 8px;
}
.overlay-controls label { font-size:14px; cursor:pointer;}

.top-buttons {
    position:absolute; top:0; left:0; width:100vw;
    display:flex; flex-wrap:wrap; gap:6px; z-index:100;
    align-items:center; background:linear-gradient(90deg,#242c3c 82%,#423877 100%);
    padding:7px 5px 4px 5px; box-sizing:border-box;
}
.mode-btn, button { border-radius:9px; border:2px solid #8882; cursor:pointer; font-weight:bold; font-size:1.05em; padding:6px 9px;}
#latLonInput, #placeInput { min-width:90px; width:25vw; max-width:150px; padding:6px; border-radius:7px; border:1px solid #aaa; color:#222; background:#eefdff;}
#cursorLatLon{ min-width:90px; padding:6px 10px; border-radius:7px; background:#eefdff; color:#222; font-family:monospace; font-size:13px;}

.location-marker {
    position: absolute;
    padding: 2px 4px;
    border-radius: 50%;
    font-size: 18px;
    transform: translate(-50%, -100%);
    border: 0;
    box-shadow: 0 1px 5px #0004;
    z-index: 150;
    background: transparent;
    line-height: 1;
}

#homeBtn { margin-left:auto; }

.weather-panel {
    position: fixed; right: 8px; top: 50%; transform: translateY(-50%);
    min-width: 190px; max-width: 38vw; border-radius: 12px;
    padding: 12px 14px 12px 14px; font-size: 0.92em;
    box-shadow: 0 3px 20px #193e7e88; z-index: 302;
    display: none; word-break: break-word;
}
.weather-panel.active { display: block; }
.weather-panel button { float:right; background:transparent; border: 0; font-size:1.1em; }

/* Bottom forecast bar */
.forecast-bar {
    position: fixed;
    left: 0;
    bottom: 0;
    width: 100vw;
    background: #141829f0;
    color: #f5f7ff;
    z-index: 303;
    box-sizing: border-box;
    padding: 5px 8px 6px 8px;
    font-size: 0.82em;
    display: block;
}
.forecast-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 4px;
}
.forecast-header select {
    padding: 3px 5px;
    border-radius: 6px;
    border: 1px solid #999;
    font-size: 0.8em;
}
.forecast-header-spacer {
    margin-left: auto;
}
.forecast-hide-btn {
    background: transparent;
    border: 1px solid #ffffff55;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    color: #fff;
    cursor: pointer;
    font-size: 0.9em;
    display: flex;
    align-items: center;
    justify-content: center;
}
.forecast-scroll {
    display: flex;
    overflow-x: auto;
    gap: 4px;
    padding-bottom: 2px;
}
.forecast-item {
    flex: 0 0 auto;
    min-width: 110px;
    padding: 3px 5px;
    border-radius: 8px;
    background: #252b3cff;
    text-align: left;
    box-shadow: 0 1px 4px #0008;
}
.forecast-item-time {
    font-size: 0.75em;
    opacity: 0.82;
    margin-bottom: 2px;
}
.forecast-item-temp {
    font-weight: bold;
    margin-bottom: 1px;
}
.forecast-item-line {
    font-size: 0.74em;
}
.forecast-item-icon {
    font-size: 1.1em;
    margin-right: 4px;
    vertical-align: middle;
}

/* Mobile portrait optimizations */
@media (max-width: 600px) {
  .top-buttons {
    gap:4px;
    padding:5px 4px 3px 4px;
  }
  .mode-btn, button {
    font-size:0.9em;
    padding:5px 7px;
  }
  #placeInput, #latLonInput {
    width:34vw;
    max-width:none;
    font-size:0.85em;
  }
  #cursorLatLon{
    font-size:0.8em;
    padding:4px 6px;
  }
  .overlay-controls {
    padding:5px;
  }
  .overlay-controls label {
    font-size:12px;
  }
  .weather-panel {
    right:4px;
    max-width: 70vw;
    padding:10px 10px 10px 12px;
    font-size:0.84em;
  }
  .forecast-bar {
    font-size:0.78em;
    padding:4px 6px 5px 6px;
  }
  .forecast-item {
    min-width:100px;
  }
  .forecast-header span {
    font-size:0.9em;
  }
  .forecast-header label {
    font-size:0.8em;
  }
}

/* Extra small screens */
@media (max-width: 430px) {
  .top-buttons {
    row-gap:3px;
  }
  #placeInput, #latLonInput {
    width:40vw;
  }
  .mode-btn {
    font-size:0.85em;
  }
}
</style>
</head>
<body class="dusk-mode">
<div class="map-container">
  <div class="map-viewport">
    <div class="map-tiles-wrap" id="tilesWrap" style="background:#111;">
      <!-- Maps and overlays will be injected here by JS -->
    </div>
  </div>

  <div class="overlay-controls" id="overlayControls">
    <label><input type="radio" name="overlay" value="none" checked> No overlay</label>
    <label><input type="radio" name="overlay" value="clouds"> Clouds ‚òÅÔ∏è</label>
    <label><input type="radio" name="overlay" value="precipitation"> Precipitation üåßÔ∏è</label>
    <label><input type="radio" name="overlay" value="wind"> Wind üí®</label>
    <label><input type="radio" name="overlay" value="temp"> Temperature üå°Ô∏è</label>
    <label><input type="radio" name="overlay" value="swell"> Swell üåä</label>
    <label><input type="radio" name="overlay" value="windwaves"> Wind waves üåäüí®</label>
  </div>

  <div class="top-buttons">
    <button class="mode-btn" id="duskBtn" title="Dusk Mode">üåÜ</button>
    <button class="mode-btn" id="dayBtn" title="Day Mode">üå§Ô∏è</button>
    <button class="mode-btn" id="zoomInBtn" title="Zoom In">Ôºã</button>
    <button class="mode-btn" id="zoomOutBtn" title="Zoom Out">Ôºç</button>
    <input id="placeInput" placeholder="Type place name">
    <button id="placeGo">Go</button>
    <input id="latLonInput" placeholder="Deg Min N/S, Deg Min E/W">
    <button id="latLonGo">Go</button>
    <div id="cursorLatLon">‚Äî</div>
    <button class="mode-btn" id="toggleForecastBtn" title="Show/Hide Forecast">üìä Show forecast</button>
    <button class="mode-btn" id="homeBtn" title="Home" style="margin-left:auto;">üè† Home</button>
  </div>

  <div class="weather-panel" id="weatherPanel">
    <button id="closePanel" aria-label="Close">&times;</button>
    <div id="panelContent"></div>
  </div>

  <!-- 5-day forecast bar -->
  <div class="forecast-bar" id="forecastBar">
    <div class="forecast-header">
      <span>5‚Äëday forecast</span>
      <label for="forecastStep">Interval:</label>
      <select id="forecastStep">
        <option value="1">1 hr</option>
        <option value="3" selected>3 hr</option>
        <option value="6">6 hr</option>
        <option value="12">12 hr</option>
        <option value="18">18 hr</option>
        <option value="24">24 hr</option>
        <option value="48">48 hr</option>
        <option value="72">72 hr</option>
        <option value="96">96 hr</option>
      </select>
      <div class="forecast-header-spacer"></div>
      <button class="forecast-hide-btn" id="hideForecastBtn" title="Hide forecast">‚¨á</button>
    </div>
    <div class="forecast-scroll" id="forecastItems"></div>
  </div>
</div>

<script>
const apikey = "5eeba413966ed394db4d2df220015db4";
const tilesWrap = document.getElementById("tilesWrap");
let viewWidth = window.innerWidth;

let lastForecastData = null;      // OpenWeather 5-day /3h
let lastMarineForecast = null;    // Open-Meteo marine hourly

const forecastStepSelect = document.getElementById("forecastStep");
const forecastItems = document.getElementById("forecastItems");
const forecastBar = document.getElementById("forecastBar");
const toggleForecastBtn = document.getElementById("toggleForecastBtn");
const hideForecastBtn = document.getElementById("hideForecastBtn");

function addTileImgs(layerClass) {
  for(let i=0; i<3; ++i) {
    let img = document.createElement("img");
    img.className = layerClass;
    img.style.left = (i*100) + 'vw';
    img.style.top = '0';
    if (layerClass=="world-map") {
      img.src="https://upload.wikimedia.org/wikipedia/commons/8/80/World_map_-_low_resolution.svg";
      img.draggable = false;
      tilesWrap.appendChild(img);
    } else {
      img.src = '';
      img.draggable = false;
      img.dataset.tileIdx = i;
      img.style.zIndex = 50;
      img.classList.add('overlay-img','hidden');
      tilesWrap.appendChild(img);
    }
  }
}
addTileImgs("world-map");
addTileImgs("overlay-img clouds");
addTileImgs("overlay-img precipitation");
addTileImgs("overlay-img wind");
addTileImgs("overlay-img temp");
addTileImgs("overlay-img swell");
addTileImgs("overlay-img windwaves");

window.addEventListener("resize", ()=>{ viewWidth=window.innerWidth; updateMap(); updateOverlayImgs(); });

/* Tile overlay ids ‚Äì replace swell/windwaves with your actual marine tile ids. [web:77] */
const overlayTypes = {
  'clouds':'clouds_new',
  'precipitation':'precipitation_new',
  'wind':'wind_new',
  'temp':'temp_new',
  'swell':'swell_layer_id',
  'windwaves':'windwaves_layer_id'
};

const overlayControls = document.getElementById("overlayControls");
let overlayState = "none";

overlayControls.addEventListener("change",e=>{
  overlayState=e.target.value;
  updateOverlayImgs();
});

function updateOverlayImgs() {
  ["clouds","precipitation","wind","temp","swell","windwaves"].forEach(type=>{
    Array.from(tilesWrap.querySelectorAll(`.overlay-img.${type}`)).forEach((img,i)=>{
        if (overlayState!==type) {
          img.classList.add("hidden");
        } else {
          img.classList.remove("hidden");
          const layerName = overlayTypes[type];
          img.src = `https://tile.openweathermap.org/map/${layerName}/0/${i}/0.png?appid=${apikey}`;
        }
    });
  });
  if (overlayState==="none") {
    Array.from(tilesWrap.querySelectorAll(`.overlay-img`)).forEach(img=>img.classList.add("hidden"));
  }
}
updateOverlayImgs();

let mapZoom = 1;
let panOffset = 0, dragStart = 0, panY = 0, isDragging = false;

function updateMap() {
    tilesWrap.style.transform = `scale(${mapZoom}) translateX(${(panOffset - viewWidth)/mapZoom}px) translateY(${panY/mapZoom}px)`;
    updateOverlayImgs();
}

function beginDrag(x){ isDragging = true; dragStart = x; tilesWrap.classList.add('dragging'); }
function moveDrag(x){ panOffset += x - dragStart; dragStart = x; updateMap(); }
function endDrag(){
    viewWidth = window.innerWidth;
    panOffset = ((panOffset % viewWidth) + viewWidth) % viewWidth;
    updateMap(); isDragging = false; tilesWrap.classList.remove('dragging');
}

tilesWrap.addEventListener('mousedown', function(e){
  if (e.button===0 && !e.target.closest('.top-buttons')) {
    beginDrag(e.clientX);
  }
});
window.addEventListener('mousemove', function(e){ if (isDragging) moveDrag(e.clientX); });
window.addEventListener('mouseup', function(){ if (isDragging) endDrag(); });

tilesWrap.addEventListener('touchstart', function(e){
  if (!e.target.closest('.top-buttons') && e.touches.length === 1) {
    beginDrag(e.touches[0].clientX);
  }}, {passive:false});
tilesWrap.addEventListener('touchmove', function(e){
  if (isDragging && e.touches.length === 1) {
    e.preventDefault(); moveDrag(e.touches[0].clientX);
  }}, {passive:false});
tilesWrap.addEventListener('touchend', function(e){ if (isDragging) endDrag(); }, {passive:false});

document.getElementById("zoomInBtn").onclick = () => { if (mapZoom < 4) { mapZoom += 0.25; updateMap(); } };
document.getElementById("zoomOutBtn").onclick = () => { if (mapZoom > 1) { mapZoom -= 0.25; updateMap(); } };

const duskBtn = document.getElementById("duskBtn"),
      dayBtn  = document.getElementById("dayBtn");

function setMode(mode) {
    document.body.classList.remove("dusk-mode", "day-mode");
    if (mode === "dusk") document.body.classList.add("dusk-mode");
    else document.body.classList.add("day-mode");
    localStorage.setItem("mode",mode);
}
duskBtn.onclick = ()=>setMode("dusk");
dayBtn.onclick  = ()=>setMode("day");
(function(){ let mode = localStorage.getItem("mode"); setMode(mode === "day" ? "day" : "dusk"); })();

const weatherPanel = document.getElementById("weatherPanel");
const panelContent = document.getElementById("panelContent");
const closePanel = document.getElementById("closePanel");
let currentMarker = null;

/* Top-right panel: current weather only */
function showWeatherPanel(data, lat, lon) {
    const name = data?.name || '';
    const weather = data?.weather?.[0];
    let icon = weather?.icon ? `<img src="https://openweathermap.org/img/wn/${weather.icon}@2x.png" style="width:40px;height:40px;vertical-align:middle;">` : '';
    const desc = weather?.description || '';
    const temp = data?.main?.temp !== undefined ? Math.round(data.main.temp)+"¬∞C" : '‚Äî';
    const wind = data?.wind?.speed !== undefined ? (data.wind.speed + " m/s") : '‚Äî';
    const hum  = data?.main?.humidity !== undefined ? (data.main.humidity + "%") : '‚Äî';
    let coordsInfo = lat && lon ? `<div style="font-size:.82em;opacity:.78">${(+lat).toFixed(4)}, ${(lon).toFixed(4)}</div>` : '';

    panelContent.innerHTML = `
      <b style="font-size:1.1em">${icon}${name?name:"Lat/Lon"}</b> ${coordsInfo}
      <div>${desc}</div>
      <div>üå° Temp: <b>${temp}</b></div>
      <div>üíß Humidity: <b>${hum}</b></div>
      <div>üå¨ Wind: <b>${wind}</b></div>
    `;
    weatherPanel.classList.add("active");
}
closePanel.onclick = () => weatherPanel.classList.remove("active");

/* Align marine hourly wave data with OpenWeather 3-hour forecast grid. */
function getMarineAtTime(targetTimeMs) {
    if (!lastMarineForecast || !lastMarineForecast.hourly || !Array.isArray(lastMarineForecast.hourly.time)) {
        return { wave_height: null, swell_wave_height: null, wind_wave_height: null };
    }
    const times = lastMarineForecast.hourly.time;
    const wh = lastMarineForecast.hourly.wave_height || [];
    const swh = lastMarineForecast.hourly.swell_wave_height || [];
    const wwh = lastMarineForecast.hourly.wind_wave_height || [];

    let bestIdx = -1;
    let bestDiff = Infinity;
    for (let i = 0; i < times.length; i++) {
        const tMs = Date.parse(times[i]);
        const diff = Math.abs(tMs - targetTimeMs);
        if (diff < bestDiff) {
            bestDiff = diff;
            bestIdx = i;
        }
    }
    if (bestIdx === -1) return { wave_height: null, swell_wave_height: null, wind_wave_height: null };

    return {
        wave_height: wh[bestIdx] ?? null,
        swell_wave_height: swh[bestIdx] ?? null,
        wind_wave_height: wwh[bestIdx] ?? null
    };
}

/* Forecast bar rendering using both OpenWeather + Open-Meteo Marine. */
function renderForecastBar() {
    forecastItems.innerHTML = "";
    if (!lastForecastData || !Array.isArray(lastForecastData.list)) return;

    const stepHours = parseInt(forecastStepSelect.value, 10);
    const list = lastForecastData.list;

    const baseStep = 3;
    const indicesStep = Math.max(1, Math.round(stepHours / baseStep));

    for (let i = 0; i < list.length; i += indicesStep) {
        const entry = list[i];
        const dtMs = entry.dt * 1000;
        const d = new Date(dtMs);
        const hour = d.getHours().toString().padStart(2,"0");
        const day = d.getDate().toString().padStart(2,"0");
        const month = (d.getMonth()+1).toString().padStart(2,"0");

        const temp = entry.main && entry.main.temp !== undefined ? Math.round(entry.main.temp) + "¬∞C" : "‚Äî";
        const wind = entry.wind && entry.wind.speed !== undefined ? entry.wind.speed.toFixed(1) + " m/s" : "‚Äî";
        const hum  = entry.main && entry.main.humidity !== undefined ? entry.main.humidity + "%" : "‚Äî";

        const rain = entry.rain && entry.rain["3h"] !== undefined ? entry.rain["3h"] : 0;
        const snow = entry.snow && entry.snow["3h"] !== undefined ? entry.snow["3h"] : 0;
        const precipTotal = rain + snow;
        const precipText = precipTotal > 0 ? precipTotal.toFixed(1) + " mm" : "0 mm";

        const weather = entry.weather && entry.weather[0];
        const desc = weather?.description || "";
        const iconCode = weather?.icon;
        const iconUrl = iconCode ? `https://openweathermap.org/img/wn/${iconCode}.png` : "";

        const marine = getMarineAtTime(dtMs);
        const swell = marine.swell_wave_height != null ? marine.swell_wave_height.toFixed(1) + " m" : "‚Äî";
        const windWave = marine.wind_wave_height != null ? marine.wind_wave_height.toFixed(1) + " m" : "‚Äî";

        const item = document.createElement("div");
        item.className = "forecast-item";
        item.innerHTML = `
          <div class="forecast-item-time">${day}/${month} ${hour}:00</div>
          <div class="forecast-item-temp">${temp}</div>
          <div class="forecast-item-line">
            ${iconUrl ? `<img src="${iconUrl}" alt="" class="forecast-item-icon">` : ""}<span>${desc}</span>
          </div>
          <div class="forecast-item-line">Wind: ${wind}</div>
          <div class="forecast-item-line">Hum: ${hum}</div>
          <div class="forecast-item-line">Precip: ${precipText}</div>
          <div class="forecast-item-line">Swell: ${swell}</div>
          <div class="forecast-item-line">Wind wave: ${windWave}</div>
        `;
        forecastItems.appendChild(item);
    }
}

forecastStepSelect.addEventListener("change", renderForecastBar);

/* Forecast bar toggle buttons */
function toggleForecast() {
    if (forecastBar.style.display === "none") {
        forecastBar.style.display = "block";
    } else {
        forecastBar.style.display = "none";
    }
}
toggleForecastBtn.onclick = toggleForecast;
hideForecastBtn.onclick = toggleForecast;

/* Click ‚Üí fetch current + 5-day forecast + marine forecast + drop single üìç marker */
tilesWrap.addEventListener("click", function(e){
    if (e.target.closest('.top-buttons,.location-marker')) return;

    const r = tilesWrap.getBoundingClientRect();
    const ww = r.width;

    let xPx = e.clientX - r.left - panOffset;
    xPx = ((xPx % ww) + ww) % ww;

    const xNorm = xPx / ww;
    const yNorm = (e.clientY - r.top) / r.height;

    if (xNorm < 0 || xNorm > 1 || yNorm < 0 || yNorm > 1) return;

    const lon = xNorm * 360 - 180;
    const latRad = (0.5 - yNorm) * Math.PI;
    const lat = (180 / Math.PI) * Math.atan(Math.sinh(latRad));

    fetchWeatherAndForecast(lat, lon);
});

/* Combined current + 5 day + marine. */
async function fetchWeatherAndForecast(lat, lon) {
    const weatherUrl   = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apikey}&units=metric`;
    const forecastUrl  = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${apikey}&units=metric`;
    const marineUrl    = `https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lon}&hourly=wave_height,swell_wave_height,wind_wave_height&length=120`;

    const [weatherRes, forecastRes, marineRes] = await Promise.all([
        fetch(weatherUrl),
        fetch(forecastUrl),
        fetch(marineUrl)
    ]);

    const weatherData  = await weatherRes.json();
    const forecastData = await forecastRes.json();
    const marineData   = await marineRes.json();

    lastForecastData = forecastData;
    lastMarineForecast = marineData;

    showWeatherPanel(weatherData, lat, lon);
    placeMarkerAt(lat, lon);
    renderForecastBar();
}

/* Always keep only one marker: remove previous then add new üìç */
function placeMarkerAt(lat, lon) {
    if (currentMarker) currentMarker.remove();

    const marker = document.createElement("div");
    marker.className = "location-marker";
    marker.textContent = "üìç";

    const latRad = Math.atanh(Math.sin(lat * Math.PI / 180));
    const yPercent = (0.5 - latRad / Math.PI) * 100;
    const xPercent = ((lon + 180) / 360) * 100;

    marker.style.top = yPercent + "%";
    marker.style.left = xPercent + "%";

    currentMarker = marker;
    tilesWrap.appendChild(marker);
}

/* Place search + full forecast */
document.getElementById("placeGo").onclick = handlePlaceSearch;
document.getElementById("placeInput").onkeypress = function(e){ if (e.key==="Enter") handlePlaceSearch(); };

async function handlePlaceSearch() {
    let place = document.getElementById("placeInput").value.trim();
    if (!place) return;
    let url = "https://api.openweathermap.org/data/2.5/weather?q=" + encodeURIComponent(place) + "&appid=" + apikey + "&units=metric";
    let res = await fetch(url); let data = await res.json();
    if (!data.coord) { alert("Place not found"); return; }
    const lat = data.coord.lat;
    const lon = data.coord.lon;

    const forecastUrl  = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${apikey}&units=metric`;
    const marineUrl    = `https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lon}&hourly=wave_height,swell_wave_height,wind_wave_height&length=120`;

    const [forecastRes, marineRes] = await Promise.all([
        fetch(forecastUrl),
        fetch(marineUrl)
    ]);

    lastForecastData = await forecastRes.json();
    lastMarineForecast = await marineRes.json();

    showWeatherPanel(data, lat, lon);
    placeMarkerAt(lat, lon);
    renderForecastBar();
}

/* Lat/lon search + full forecast */
document.getElementById("latLonGo").onclick = handleLatLonSearch;
document.getElementById("latLonInput").onkeypress = function(e){ if(e.key==="Enter") handleLatLonSearch(); };

async function handleLatLonSearch() {
    const value = document.getElementById("latLonInput").value.trim();
    const pattern = /([0-9]{1,3})[¬∞\s]*([0-9]{1,2}(?:\.\d+)?)[\'\s]*([NSns]),?\s*([0-9]{1,3})[¬∞\s]*([0-9]{1,2}(?:\.\d+)?)[\'\s]*([EWew])/;
    const match = value.match(pattern);
    if (!match) { alert("Format: 37 47.5 N, 122 25.2 W"); return; }
    let latDeg = parseFloat(match[1]), latMin = parseFloat(match[2]), latDir = match[3].toUpperCase();
    let lonDeg = parseFloat(match[4]), lonMin = parseFloat(match[5]), lonDir = match[6].toUpperCase();
    let lat = latDeg + (latMin / 60); if (latDir === "S") lat = -lat;
    let lon = lonDeg + (lonMin / 60); if (lonDir === "W") lon = -lon;

    const weatherUrl   = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apikey}&units=metric`;
    const forecastUrl  = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${apikey}&units=metric`;
    const marineUrl    = `https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lon}&hourly=wave_height,swell_wave_height,wind_wave_height&length=120`;

    const [weatherRes, forecastRes, marineRes] = await Promise.all([
        fetch(weatherUrl),
        fetch(forecastUrl),
        fetch(marineUrl)
    ]);

    const weatherData  = await weatherRes.json();
    const forecastData = await forecastRes.json();
    const marineData   = await marineRes.json();

    lastForecastData = forecastData;
    lastMarineForecast = marineData;

    showWeatherPanel(weatherData, lat, lon);
    placeMarkerAt(lat, lon);
    renderForecastBar();
}

/* Cursor lat/lon readout */
const cursorLatLon = document.getElementById("cursorLatLon");
tilesWrap.addEventListener("mousemove", function(e){
    const r = tilesWrap.getBoundingClientRect();
    const ww = r.width;
    let xPx = e.clientX - r.left - panOffset;
    xPx = ((xPx % ww) + ww) % ww;

    const x = xPx / ww;
    const y = (e.clientY - r.top) / r.height;
    if (x < 0 || x > 1 || y < 0 || y > 1) { cursorLatLon.textContent = '‚Äî'; return; }
    const lon = (x * 360 - 180).toFixed(2);
    const latRad = (0.5 - y) * Math.PI;
    const lat = ((180 / Math.PI) * Math.atan(Math.sinh(latRad))).toFixed(2);
    cursorLatLon.textContent = lat + "," + lon;
});
tilesWrap.addEventListener("mouseleave", ()=> cursorLatLon.textContent = "‚Äî");

// Home button action
document.getElementById("homeBtn").onclick = () => {
    window.location.href = "index.html";
};
</script>
</body>
</html>
